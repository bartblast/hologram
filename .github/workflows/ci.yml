name: CI

# Fast lane: PRs and feature branches run 4 lib tests + 1 feature test (5 total)
# Full matrix: Merges to dev/master run all 72 lib tests + 36 feature tests (108 total)
on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

permissions:
  contents: read

jobs:
  # Determine which matrix strategy to use based on the branch
  determine_strategy:
    runs-on: ubuntu-latest
    outputs:
      matrix_mode: ${{ steps.check.outputs.matrix_mode }}
    steps:
      - id: check
        shell: bash
        run: |
          # Run full matrix only when pushing to dev or master branches
          if [[ "${{ github.event_name }}" == "push" && ("${{ github.ref }}" == "refs/heads/dev" || "${{ github.ref }}" == "refs/heads/master") ]]; then
            echo "matrix_mode=full" >> $GITHUB_OUTPUT
            echo "Running FULL matrix (108 jobs) for ${{ github.ref }}"
          else
            echo "matrix_mode=fast" >> $GITHUB_OUTPUT
            echo "Running FAST lane (5 jobs) for PR or feature branch"
          fi

  # Run lib tests with conditional matrix
  lib_tests:
    needs: determine_strategy
    uses: ./.github/workflows/ci-lib-tests.yml
    with:
      matrix_mode: ${{ needs.determine_strategy.outputs.matrix_mode }}

  # Run feature tests with conditional matrix
  feature_tests:
    needs: determine_strategy
    uses: ./.github/workflows/ci-feature-tests.yml
    with:
      matrix_mode: ${{ needs.determine_strategy.outputs.matrix_mode }}

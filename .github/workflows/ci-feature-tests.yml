name: CI - Feature Tests (Reusable)

on:
  workflow_call:
    inputs:
      matrix_mode:
        required: true
        type: string
        description: 'fast or full'

env:
  MIX_ENV: test

permissions:
  contents: read

jobs:
  feature_tests:
    runs-on: ubuntu-latest
    name: Feature Tests on ubuntu-latest, Elixir ${{ matrix.elixir }}, OTP ${{ matrix.otp }}, Node.js ${{ matrix.node }}
    defaults:
      run:
        working-directory: test/features
    strategy:
      fail-fast: false
      matrix: ${{ inputs.matrix_mode == 'fast' && fromJSON('{"include":[{"elixir":"1.18.2","otp":"27.2","node":"22.9.0"}]}') || fromJSON('{"elixir":["1.15.8","1.16.3","1.17.3","1.18.2"],"otp":["24.3","25.3","26.2","27.2"],"node":["20.16.0","21.7.3","22.9.0"],"exclude":[{"elixir":"1.15.8","otp":"27.2"},{"elixir":"1.16.3","otp":"27.2"},{"elixir":"1.17.3","otp":"24.3"},{"elixir":"1.18.2","otp":"24.3"}]}') }}
    env:
      IS_HIGHEST_MATRIX_COMBINATION: ${{ contains(matrix.elixir, '1.18.2') && contains(matrix.otp, '27.2') && contains(matrix.node, '22.9.0') }}
    steps:
      # Step: Setup Elixir + Erlang/OTP image as the base.
      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          hexpm-mirrors: |
            https://builds.hex.pm
            https://cdn.jsdelivr.net/hex
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}

      # Step: Checkout the code.
      - name: Checkout code
        uses: actions/checkout@v6

      # Step: Setup Node.js.
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}

      ### FEATURE TESTS APP CHECKS ###

      # Step: Define how to cache the feature tests app Elixir dependencies.
      - name: Cache feature tests app Elixir deps
        id: cache-feature-tests-app-elixir-deps
        uses: actions/cache@v5
        env:
          cache-name: cache-feature-tests-app-elixir-deps
        with:
          path: test/features/deps
          key: ${{ env.cache-name }}-${{ runner.os }}-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('test/features/mix.lock') }}

      # Step: Define how to cache the feature tests app Elixir build.
      - name: Cache feature tests app Elixir build
        id: cache-feature-tests-app-elixir-build
        uses: actions/cache@v5
        env:
          cache-name: cache-feature-tests-app-elixir-build
        with:
          path: test/features/_build
          key: ${{ env.cache-name }}-${{ runner.os }}-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('test/features/mix.lock') }}

      # Step: Download feature tests app Elixir dependencies.
      # If unchanged, uses the cached version.
      - name: Download feature tests app Elixir deps
        uses: nick-fields/retry@v3
        with:
          # TODO: set working directory with action input when https://github.com/nick-fields/retry/issues/89 is implemented
          command: cd test/features && mix deps.get
          shell: bash
          timeout_minutes: 3
          max_attempts: 10

      # Step: Compile the feature tests app project treating any warnings as errors.
      - name: Check feature tests app project compiles without warnings
        run: mix compile --all-warnings --warnings-as-errors

      # Step: Check if feature tests app mix.lock has any unused dependencies.
      - name: Check feature tests app unused Elixir deps
        if: ${{ env.IS_HIGHEST_MATRIX_COMBINATION == 'true' }}
        run: mix deps.unlock --check-unused

      # Step: Check if there are any feature tests app Elixir dependencies which have been marked as retired.
      - name: Check feature tests app retired Elixir deps
        if: ${{ env.IS_HIGHEST_MATRIX_COMBINATION == 'true' }}
        run: mix hex.audit

      # Step: Check that the feature tests app Elixir code has already been formatted.
      - name: Check feature tests app Elixir code formatted
        if: ${{ env.IS_HIGHEST_MATRIX_COMBINATION == 'true' }}
        run: mix format --check-formatted

      # Step: Run feature tests app Elixir static code analysis with Credo.
      - name: Run feature tests app Elixir static code analysis with Credo
        if: ${{ env.IS_HIGHEST_MATRIX_COMBINATION == 'true' }}
        run: mix credo --strict

      # Step: Restore feature tests app Dialyzer PLT cache.
      # Cache key is based on Erlang/Elixir version and the mix.lock hash.
      - name: Restore feature tests app Dialyzer PLT cache
        id: restore-feature-tests-app-dialyzer-plt-cache
        uses: actions/cache/restore@v5
        with:
          key: |
            dialyzer-plt-feature-tests-app-${{ runner.os }}-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('test/features/mix.lock') }}
          path: |
            test/features/priv/plts
        if: ${{ env.IS_HIGHEST_MATRIX_COMBINATION == 'true' }}

      # Step: Create feature tests app Dialyzer PLTs if no cache was found.
      - name: Create feature tests app Dialyzer PLTs
        if: ${{ env.IS_HIGHEST_MATRIX_COMBINATION == 'true' && steps.restore-feature-tests-app-dialyzer-plt-cache.outputs.cache-hit != 'true' }}
        run: mix dialyzer --plt

      # Step: Save feature tests app Dialyzer PLT cache.
      # By default, the GitHub Cache action will only save the cache if all steps in the job succeed,
      # so we separate the cache restore and save steps in case running dialyzer fails.
      - name: Save feature tests app Dialyzer PLT cache
        id: save-feature-tests-app-dialyzer-plt-cache
        uses: actions/cache/save@v5
        if: ${{ env.IS_HIGHEST_MATRIX_COMBINATION == 'true' && steps.restore-feature-tests-app-dialyzer-plt-cache.outputs.cache-hit != 'true' }}
        with:
          key: |
            dialyzer-plt-feature-tests-app-${{ runner.os }}-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('test/features/mix.lock') }}
          path: |
            test/features/priv/plts

      # Step: Run feature tests app Elixir static code analysis with Dialyzer.
      - name: Run feature tests app Elixir static code analysis with Dialyzer
        if: ${{ env.IS_HIGHEST_MATRIX_COMBINATION == 'true' }}
        run: mix dialyzer --format github

      # Step: Check that all feature tests app test scripts have valid file names.
      - name: Check feature tests app test file names
        if: ${{ env.IS_HIGHEST_MATRIX_COMBINATION == 'true' }}
        run: mix holo.test.check_file_names test

      # Step: Execute feature tests app Elixir tests.
      - name: Run feature tests app Elixir tests
        run: mix test --warnings-as-errors

      # Step: Archive the browser screenshots of tests that failed.
      - name: Archive fail screenshots
        # Execute the step even if the job has already failed, but don't execute it if the job has been canceled.
        if: success() || failure()
        uses: actions/upload-artifact@v6
        with:
          name: fail-screenshots-${{ matrix.elixir }}-${{ matrix.otp }}-${{ matrix.node }}
          path: test/features/tmp/screenshots
